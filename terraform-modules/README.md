# Terraform Setup Guide

Welcome to the Terraform Setup Guide. This document provides comprehensive instructions for configuring and managing your Terraform infrastructure deployments, specifically designed for handling multiple environments with workspaces and `.tfvars` files.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Getting Started](#getting-started)
- [Directory Structure](#directory-structure)
- [Navigating to Module Directory](#navigating-to-module-directory)
- [Managing Workspaces](#managing-workspaces)
- [Applying Configurations](#applying-configurations)
- [Variables and Outputs](#variables-and-outputs)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)
- [Example Notes](#example-assignment-notes)

## Prerequisites

Before starting, ensure you have the following tools installed:
- Terraform (>= 1.0)
- AWS CLI (configured with user credentials)

## Getting Started

To begin using this Terraform setup, clone the project repository to your local system using the following command:

```bash
git clone https://yourrepository.git
cd your-project-directory
```

## Directory Structure

The project is organized into several key directories:

- `terraform-modules/`: Contains all the modularized Terraform configurations.
- `example-terraform-workspaces/`: Stores `.tfvars` files for each specific environment.

## Navigating to Module Directory

Always change into the appropriate module directory before performing Terraform commands:
*Example:*

```bash
cd terraform-modules/terraform-vpc
```

This ensures that all operations are performed in the context of the intended module.

## Managing Workspaces

Terraform workspaces allow for managing distinct state files for separate environments, such as development, staging, and production:

### Creating a Workspace

Create a new workspace by running:

```bash
terraform workspace new example-ca-central-1-vpc-web-app-dev
```

### Selecting a Workspace

Switch between workspaces using the example workspace above:
*Example:*

```bash
terraform workspace select example-ca-central-1-vpc-web-app-dev
```

## Applying Configurations

To apply Terraform configurations, use the `.tfvars` file corresponding to your current workspace:
*Example:*

```bash
terraform apply -var-file="../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars"
```

Repeat this process for planning and destroying environments:
*Example:*

```bash
terraform plan -var-file="../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars"
terraform destroy -var-file="../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars"
```

## Variables and Outputs

### Variables

Define and use variables in your configurations to customize AWS resources:

```hcl
variable "vpc_id" {
  description = "The VPC ID to deploy resources into."
  type        = string
}
```

### Outputs

Outputs are used to retrieve important information about your resources:

```hcl
output "public_subnet_ids" {
  value = module.vpc.public_subnets
}
```

## Best Practices

- Always use version control for your Terraform files.
- Keep sensitive information out of your Terraform files and use secrets management tools.
- Regularly update Terraform and providers to the latest versions.

## Troubleshooting

Consult the Terraform documentation or the logs generated by Terraform commands to troubleshoot issues related to resource deployment.

## Example Notes

I have split the modules for this example into 2 deployments, 1 for vpc and one for ec2 resources.  This was done so we have a clearer separation of concern.  We can also add more resources with a separate workspace and share the VPC

There is 2 workspaces we are dealing with in this project, stored in the respective .tfvars files
- [`./example-terraform/workspaces/example-ca-central-1-vpc-web-app-dev.tfvars`](./example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars)
    - use the `terraform-modules/terraform-vpc` module
- [`./example-terraform/workspaces/example-ca-central-1-ec2-web-app-dev.tfvars`](./example-terraform-workspaces/example-ca-central-1-ec2-web-app-dev.tfvars)
    - use the `terraform-modules/terraform-web-app` module

Follow the instructions above to create the workspaces in the respective module folders

### Technical Considerations

- Note: you must create the VPC resources before the EC2 resources
- On destroy reverse order
- Currently the `terraform-modules/terraform-web-app` folder is not fully paramaterized like the VPC module, this was to save some time.  You can see how toggles and variables read in from the .tfvars file can be achieved in the terraform-vpc top level module. This allows us to re-use code and make the project more DRY.  However this is something that could be used for production as its stands.
- I have built out all the modules manually except for the `terraform-aws-security-group-external` module, this shows we can also use pre-build community modules in thie terraform structure.
- I intentionly split the VPC tasks and EC2 taks up to keep each workspaces smaller and separation of concerns.
- This is built with terragrunt in mind for the future
- The web-app module does use a remote(local) state to read in VPC module information, you could also hard code this information into the EC2 module as-well, but wanted to show that loading existing states is a more efficient method to share data between modules. This is made even easier when using backend(s3) (future)
- Having a NAT gateway is best practice, but not necessary if your EC2 instance has an EIP.
- You will need to define the SSL cert arn if you plan to run this project in SSL.  It should work as expected.
`/example-terraform-workspaces/example-ca-central-1-ec2-web-app-dev.tfvars`
```hcl
elb_ports = [
   {
        instance_port     = 443,
        instance_protocol = "https",
        lb_port           = 443,
        lb_protocol       = "https",
        ssl_certificate_id = "<arn>"
    }
]
...
```
- The configurations for the subnets availability zone are set to ca-central-1, you will need to pick a region that works for you. Feel free to change these settings.
`/example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars`
```hcl
public_subnets = {    
    "dmz_subnet" = {
        cidr_block = "10.10.1.0/24",
        availability_zone = "ca-central-1a",
        lb_association = true
    }
}
...
```

### Setup

#### Create the VPC Resources
```bash
cd ./terraform-modules/terraform-vpc
terraform init
terraform workspace new example-ca-central-1-vpc-web-app-dev
terraform plan -var-file ../../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars
terraform apply -var-file ../../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars
```

#### Create the EC2 Resources
```bash
cd ./terraform-modules/terraform-web-app
terraform init
terraform workspace new example-ca-central-1-ec2-web-app-dev
terraform plan -var-file ../../example-terraform-workspaces/example-ca-central-1-ec2-web-app-dev.tfvars
terraform apply -var-file ../../example-terraform-workspaces/example-ca-central-1-ec2-web-app-dev.tfvars
```

### Destroy 

#### Destroy the EC2 Resources
```bash
cd ./terraform-modules/terraform-vpc
terraform init
terraform destroy -var-file ../../example-terraform-workspaces/example-ca-central-1-ec2-web-app-dev.tfvars
terraform workspace delete example-ca-central-1-ec2-web-app-dev
```

#### Destroy the VPC Resources
```bash
cd ./terraform-modules/terraform-web-app
terraform init
terraform destroy -var-file ../../example-terraform-workspaces/example-ca-central-1-vpc-web-app-dev.tfvars
terraform workspace delete example-ca-central-1-vpc-web-app-dev
```
